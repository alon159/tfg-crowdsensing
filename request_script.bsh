import org.json.JSONObject;
import org.json.JSONArray;
import com.apvereda.db.Entity;
import com.apvereda.db.Value;
import com.apvereda.db.Avatar;
import com.apvereda.utils.DigitalAvatarController;
import com.apvereda.uDataTypes.EntityType;
import java.util.HashMap;
import java.util.Iterator;
import java.util.Map;

JSONObject resultsjson = new JSONObject();
String result;

Entity crowdpoll = (Entity) dac.getAll("DA-Poll"+poll, type).get(0);
Value myresult = (Value) crowdpoll.get("myresult");
try{
    if (myresult != null){
        JSONObject myresultjson = new JSONObject(myresult.get());
        for (int i=0; i<myresultjson.length(); i++) {
            String key = "q"+i;
            JSONObject values = new JSONObject();
            values.put(myresultjson.getString(key), 1);
            resultsjson.put(key, values);
        }
    }

    Value contactsResults = (Value) crowdpoll.get("results");
    if (contactsResults != null){
        JSONArray cresultsjson = new JSONArray(contactsResults.get());
        for(int i=0; i<cresultsjson.length(); i++){
            JSONObject cresult = cresultsjson.getJSONObject(i);
            for (int j=0; j<cresult.length(); j++) {
                String key = "q"+j;
                JSONObject values = myresultjson.get(key);
                if (values != null) {
                    if (values.has(cresult.getString(key))) {
                        values.put(cresult.getString(key), values.get(cresult.getInt(key)) + 1);
                    } else {
                        values.put(cresult.getString(key), 1);
                    }
                }
                resultsjson.put(key, values);
            }
        }
    }

    if (!resultsjson.isEmpty()){
    StringBuilder resultSB = new StringBuilder("{");
    for (int i=0; i<resultsjson.length(); i++) {
        String key = "q"+i;
        Map<Integer, Integer> values = resultsjson.get(key);
        resultSB.append("'").append(key).append("' : {");
        for (Integer value : values.keySet()) {
            resultSB.append("'").append(value).append("' : '").append(values.get(value)).append("' , ");
        }
        resultSB.delete(resultSB.length()-3, resultSB.length()-1);
        resultSB.append("} , ");
    }
    resultSB.delete(resultSB.length()-3, resultSB.length()-1);
    resultSB.append("}");
    result = resultSB.toString();
    }

} catch (JSONException e){
    throw new RuntimeException(e);
}
